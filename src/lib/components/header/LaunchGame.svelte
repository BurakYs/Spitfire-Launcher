<script lang="ts">
  import Button from '$components/ui/Button.svelte';
  import { launcherAppClient2 } from '$lib/constants/clients';
  import Authentication from '$lib/core/authentication';
  import { activeAccountStore as activeAccount, settingsStorage } from '$lib/core/data-storage';
  import Manifest from '$lib/core/manifest';
  import { runningAppIds } from '$lib/stores';
  import { handleError, shouldIgnoreError, sleep, t } from '$lib/utils/util';
  import type { LegendaryLaunchData } from '$types/legendary';
  import { path } from '@tauri-apps/api';
  import { invoke } from '@tauri-apps/api/core';
  import GamePad2Icon from 'lucide-svelte/icons/gamepad-2';
  import CircleStopIcon from 'lucide-svelte/icons/circle-stop';
  import { toast } from 'svelte-sonner';

  const fortniteAppId = 'Fortnite';
  const launchData: LegendaryLaunchData & { game_id: string } = {
    game_id: fortniteAppId,
    game_parameters: [],
    game_executable: 'FortniteGame/Binaries/Win64/FortniteLauncher.exe',
    game_directory: '',
    egl_parameters: [],
    launch_command: [],
    working_directory: '',
    user_parameters: [],
    environment: {},
    pre_launch_command: '',
    pre_launch_wait: false
  };

  let isLaunching = $state(false);
  let isStopping = $state(false);

  async function launchFortnite() {
    if (runningAppIds.has(fortniteAppId)) {
      toast.error($t('launchGame.alreadyRunning'));
      return;
    }

    isLaunching = true;
    const toastId = toast.loading($t('launchGame.launching'));

    try {
      const manifestData = await Manifest.getFortniteManifest();
      const customPath = $settingsStorage?.app?.gamePath;

      let gameDirectory = manifestData?.installLocation;
      if (customPath) {
        const [customInstallDir] = customPath.replaceAll('\\', '/').split('/FortniteGame/Binaries/Win64');
        gameDirectory = customInstallDir;
      }

      if (!gameDirectory) {
        toast.error($t('launchGame.notInstalled'), { id: toastId });
        return;
      }

      launchData.game_directory = gameDirectory;
      launchData.working_directory = await path.join(gameDirectory, 'FortniteGame/Binaries/Win64');

      const deviceAuthResponse = await Authentication.getAccessTokenUsingDeviceAuth($activeAccount!);
      const oldExchangeData = await Authentication.getExchangeCodeUsingAccessToken(deviceAuthResponse.access_token);
      const launcherAccessTokenData = await Authentication.getAccessTokenUsingExchangeCode(oldExchangeData.code, launcherAppClient2);
      const launcherExchangeData = await Authentication.getExchangeCodeUsingAccessToken(launcherAccessTokenData.access_token);

      launchData.game_parameters = manifestData?.launchCommand.split(' ') || [];
      launchData.egl_parameters = [
        '-AUTH_LOGIN=unused',
        `-AUTH_PASSWORD=${launcherExchangeData.code}`,
        '-AUTH_TYPE=exchangecode',
        '-epicapp=Fortnite',
        '-epicenv=Prod',
        '-EpicPortal',
        `-epicusername=${deviceAuthResponse.displayName}`,
        `-epicuserid=${$activeAccount!.accountId}`,
        `-epicsandboxid=${manifestData?.namespace || 'fn'}`
      ];

      await invoke<number>('launch_app', { launchData });
    } catch (error) {
      if (shouldIgnoreError(error)) {
        toast.dismiss(toastId);
        return;
      }

      console.error(error);

      if (typeof error === 'string' && error.toLowerCase().includes('executable not found')) {
        toast.error($t('launchGame.notInstalled'), { id: toastId });
      } else {
        toast.error($t('launchGame.failedToLaunch'), { id: toastId });
      }
    } finally {
      isLaunching = false;
    }
  }

  async function stopFortnite() {
    isStopping = true;

    const toastId = toast.loading($t('launchGame.stopping'));

    try {
      await invoke<number>('stop_app', { appId: fortniteAppId });
      toast.success($t('launchGame.stopped'), { id: toastId });
    } catch (error) {
      handleError(error, $t('launchGame.failedToStop'), toastId);
    } finally {
      // A delay to ensure the app was killed properly
      await sleep(2000);
      isStopping = false;
    }
  }
</script>

<Button
  class="flex items-center justify-between gap-x-2 shrink-0"
  disabled={!$activeAccount || (isLaunching && !runningAppIds.has(fortniteAppId)) || isStopping}
  onclick={() => runningAppIds.has(fortniteAppId) ? stopFortnite() : launchFortnite()}
  variant={runningAppIds.has(fortniteAppId) ? 'danger' : 'epic'}
>
  {#if runningAppIds.has(fortniteAppId)}
    <span class="hidden xs:block">{$t('launchGame.stop')}</span>
    <CircleStopIcon class="size-6 xs:hidden block"/>
  {:else}
    <span class="hidden xs:block">{$t('launchGame.launch')}</span>
    <GamePad2Icon class="size-6 xs:hidden block"/>
  {/if}
</Button>
